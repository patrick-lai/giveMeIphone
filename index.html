
<!DOCTYPE html>
<html>
    <head>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/push.js/0.0.11/push.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js"></script>
      <style>
        html{
          background-color: #2C2B2B;
          color: #FF8686;
          font-family: Arial;
        }

        .green{
          color: #00FF00;
        }

      </style>
    </head>
    <body>
       <h1 style="positon: fixed; margin-top: 30vh; text-align: center;">Last Ping <span id="timeStamp"> (None yet) </span></h1>
       <div id="statuses" style="text-align: center;">
         <p id="watching">
           Watching for :<br/>
         </p>
       </div>
      <script>

        var baseUrl = "/fetch?url=";

        var endPoints = {
          '7plusBlack128' : "http://www.apple.com/au/shop/retail/pickup-message?parts.0=MN4M2X%2FA&location=2000",
          '7plusBlack256' : "http://www.apple.com/au/shop/retail/pickup-message?parts.0=MN4W2X%2FA&location=2000"
        }

        for(var i in endPoints){
          $("#watching").append(i+"</br>");
        }

        window.doFetch = function(){
          for(var i in endPoints){
           var url = baseUrl+encodeURIComponent(endPoints[i]);
           var now = new Date().toString();
           $("#timeStamp").html(now);
           $.getJSON( url, function( data ) {
             var stores = data.body.stores;
             $.each(stores,function(index, value){

               var target = Object.keys(value.partsAvailability)[0];
               var storeDivID = "#"+value.storeName;
               if($(storeDivID).length == 0 ){
                 // Now create and append to iDiv
                var newStore = document.createElement('div');
                newStore.id = value.storeName;
                 $("#statuses").append(newStore);
               }

               var availability = value.partsAvailability[target].storeSelectionEnabled  ? "AVAILABLE" : "unavailiable";

               $(storeDivID).html(value.storeName+ " : "+ availability);

               if(value.partsAvailability[target].storeSelectionEnabled){
                 $(storeDivID).addClass("green");
                 foundIphone(value.partsAvailability[target].storePickupProductTitle, value.storeName, value.makeReservationUrl, value.storeImageUrl)
                 $(storeDivID).append("<p>"+value.partsAvailability[target].storePickupProductTitle+"</p>");
               }else{
                 $(storeDivID).removeClass("green");
               }

             })
           });
          }
        }

        function foundIphone(iphone,store, url, image){
            var bodyString = iphone+" at "+store;

            var audio = new Audio('http://soundbible.com/mp3/sms-alert-2-daniel_simon.mp3');
            audio.play();

            Push.create("Found", {
                body: bodyString ,
                icon: image,
                timeout: 60000,
                onClick: function () {
                    window.focus();
                    window.open(url);
                    this.close();
                }
            });
        }

        var minute = 60000;

        window.doFetch();
        setInterval(function(){
          console.log("Fetching at" + new Date().toString());
          window.doFetch();
        }, 2*minute);

      </script>
    </body>
</html>
